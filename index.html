<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filterbestands-Anwendung</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS library for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Custom styles for better look and feel */
        body {
            font-family: 'Inter', sans-serif;
        }
        .filter-container {
            max-height: 150px;
            overflow-y: auto;
        }
        @media print {
            /* Hide UI elements that shouldn't be printed */
            body > div > div:not(#print-section-container), #printButton {
                display: none;
            }
            body * {
                visibility: hidden;
            }
            #print-section, #print-section * {
                visibility: visible;
            }
            #print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            thead {
                display: table-header-group;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            h2, h3, h4 {
                page-break-after: avoid;
            }
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
        
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Filterbestands-Anwendung</h1>
            <button id="printButton" class="mt-4 sm:mt-0 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                Drucken
            </button>
        </div>

        <!-- File Input and Filters Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <!-- File Upload -->
            <div class="lg:col-span-1">
                <label for="file-upload" class="block text-sm font-medium text-gray-700 mb-1">1. Excel-Datei</label>
                <input id="file-upload" type="file" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            </div>
            <!-- Building Filter -->
            <div class="lg:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">2. Gebäude auswählen</label>
                <div id="building-filter-container" class="filter-container bg-white p-2 border border-gray-300 rounded-md">
                    <p class="text-gray-500 text-sm">Bitte zuerst Datei laden.</p>
                </div>
            </div>
             <!-- Search Input -->
            <div class="lg:col-span-1">
                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">3. Freitextsuche</label>
                <input type="text" id="search-input" placeholder="Anlage, Material-Nr, Maße..." class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" disabled>
            </div>
        </div>

        <!-- Results Section -->
        <div id="print-section-container">
            <div id="print-section">
                 <div id="results-container" class="space-y-8">
                    <!-- Results will be rendered here -->
                 </div>
            </div>
        </div>
    </div>

    <script>
        let tableData = [];
        const fileUpload = document.getElementById('file-upload');
        const buildingFilterContainer = document.getElementById('building-filter-container');
        const searchInput = document.getElementById('search-input');
        const resultsContainer = document.getElementById('results-container');
        const printButton = document.getElementById('printButton');

        fileUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json_data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                const nonEmptyRows = json_data.filter(row => row.length > 0 && row.some(cell => cell !== null && cell !== undefined && cell !== ''));

                if (nonEmptyRows.length > 1) {
                    let headerRow = nonEmptyRows[0][0] ? nonEmptyRows[0] : nonEmptyRows[1];
                    let dataRows = nonEmptyRows[0][0] ? nonEmptyRows.slice(1) : nonEmptyRows.slice(2);
                    
                    const headers = headerRow.map(h => String(h || '').trim());
                    
                    tableData = dataRows.map(row => {
                        let rowData = {};
                        headers.forEach((header, index) => {
                            rowData[header] = row[index] !== undefined && row[index] !== null ? row[index] : '';
                        });
                        return rowData;
                    });

                    enableControls();
                    populateBuildingFilter();
                    updateResults(); 
                } else {
                    resultsContainer.innerHTML = `<p class="text-center p-8 text-gray-500">Die ausgewählte Datei ist leer oder hat ein ungültiges Format.</p>`;
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function enableControls() {
            printButton.disabled = false;
            searchInput.disabled = false;
        }

        function populateBuildingFilter() {
            buildingFilterContainer.innerHTML = '';
            const buildings = [...new Set(tableData.map(item => item['Gebäude']).filter(Boolean))].sort();
            
            if (buildings.length === 0) {
                buildingFilterContainer.innerHTML = `<p class="text-gray-500 text-sm">Keine Gebäude in der Datei gefunden.</p>`;
                return;
            }

            // *** NEW ***: Add "Select All" checkbox
            const allDiv = document.createElement('div');
            allDiv.className = 'flex items-center mb-2 pb-2 border-b border-gray-200';
            const allCheckbox = document.createElement('input');
            allCheckbox.type = 'checkbox';
            allCheckbox.id = 'building-all';
            allCheckbox.className = 'h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
            allCheckbox.addEventListener('change', (event) => {
                const isChecked = event.target.checked;
                buildingFilterContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    if (cb !== allCheckbox) cb.checked = isChecked;
                });
                updateResults();
            });
            const allLabel = document.createElement('label');
            allLabel.htmlFor = 'building-all';
            allLabel.textContent = 'Alle auswählen / abwählen';
            allLabel.className = 'ml-2 block text-sm font-semibold text-gray-700';
            allDiv.appendChild(allCheckbox);
            allDiv.appendChild(allLabel);
            buildingFilterContainer.appendChild(allDiv);

            buildings.forEach(building => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `building-${building}`;
                checkbox.value = building;
                checkbox.className = 'h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
                checkbox.addEventListener('change', updateResults);

                const label = document.createElement('label');
                label.htmlFor = `building-${building}`;
                label.textContent = building;
                label.className = 'ml-2 block text-sm text-gray-900';
                
                div.appendChild(checkbox);
                div.appendChild(label);
                buildingFilterContainer.appendChild(div);
            });
        }
        
        searchInput.addEventListener('input', updateResults);

        function updateResults() {
            const selectedBuildings = Array.from(buildingFilterContainer.querySelectorAll('input[type="checkbox"]:checked:not(#building-all)'))
                                         .map(cb => cb.value);
            const searchTerm = searchInput.value.toLowerCase().trim();

            resultsContainer.innerHTML = '';

            if (selectedBuildings.length === 0) {
                resultsContainer.innerHTML = `<p class="text-center p-8 text-gray-500">Bitte wählen Sie mindestens ein Gebäude aus, um Ergebnisse anzuzeigen.</p>`;
                return;
            }

            let filteredData = tableData.filter(row => selectedBuildings.includes(row['Gebäude']));

            if (searchTerm) {
                filteredData = filteredData.filter(row => {
                    const searchableKeys = ['Material-Nr', 'Filter-Klasse', 'Filter-Typ.', 'Maße [mm]', 'RLT-Anlagen', 'Bemerkung'];
                    return searchableKeys.some(key => String(row[key] || '').toLowerCase().includes(searchTerm));
                });
            }

            if (filteredData.length === 0) {
                resultsContainer.innerHTML = `<p class="text-center p-8 text-gray-500">Für die aktuelle Auswahl und Suche wurden keine Filter gefunden.</p>`;
                return;
            }

            renderDetailedView(filteredData);
            renderSummaryView(filteredData);
        }

        function createTableFromData(data, headers) {
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            const thead = table.createTHead();
            thead.className = 'bg-gray-50';
            const headerRow = thead.insertRow();
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                th.className = 'px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                headerRow.appendChild(th);
            });

            const tbody = table.createTBody();
            tbody.className = 'bg-white divide-y divide-gray-200';
            data.forEach(rowData => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50';
                headers.forEach(header => {
                    const cell = row.insertCell();
                    cell.textContent = rowData[header] || '';
                    cell.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-700';
                });
            });
            return table;
        }

        function naturalSort(a, b) {
            return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
        }
        
        // *** NEW ***: Advanced sorting for Anlagen
        function getAnlageType(name) {
            const lowerName = String(name || '').toLowerCase().trim();
            if (lowerName.startsWith('zuluft') || lowerName.startsWith('zul') || lowerName.startsWith('zu') || /^z\d/.test(lowerName)) {
                return 1; // Zuluft
            }
            if (lowerName.startsWith('abluft') || lowerName.startsWith('abl') || /^a\d/.test(lowerName)) {
                return 2; // Abluft
            }
            return 3; // Andere
        }

        function advancedAnlagenSort(a, b) {
            const typeA = getAnlageType(a);
            const typeB = getAnlageType(b);

            if (typeA !== typeB) {
                return typeA - typeB;
            }
            return naturalSort(a, b);
        }

        function renderDetailedView(data) {
            const detailContainer = document.createElement('div');
            const title = document.createElement('h2');
            title.textContent = 'Detailansicht nach Anlagen';
            title.className = 'text-xl font-bold text-gray-800 mb-4';
            detailContainer.appendChild(title);

            const groupedByBuilding = data.reduce((acc, row) => {
                const building = row['Gebäude'];
                const anlage = row['RLT-Anlagen'] || 'Nicht zugeordnet';
                if (!acc[building]) acc[building] = {};
                if (!acc[building][anlage]) acc[building][anlage] = [];
                acc[building][anlage].push(row);
                return acc;
            }, {});

            const displayHeaders = ['Material-Nr', 'Filter-Klasse', 'Filter-Typ.', 'Maße [mm]', 'Stück', 'Bemerkung'];

            for (const building of Object.keys(groupedByBuilding).sort()) {
                const buildingTitle = document.createElement('h3');
                buildingTitle.textContent = `Gebäude: ${building}`;
                buildingTitle.className = 'text-lg font-semibold text-gray-700 mt-6 mb-2';
                detailContainer.appendChild(buildingTitle);

                for (const anlage of Object.keys(groupedByBuilding[building]).sort(advancedAnlagenSort)) {
                    const anlageTitle = document.createElement('h4');
                    anlageTitle.textContent = `Anlage: ${anlage}`;
                    anlageTitle.className = 'text-md font-medium text-gray-600 mt-4 mb-2 ml-2';
                    detailContainer.appendChild(anlageTitle);
                    
                    const anlageData = groupedByBuilding[building][anlage];
                    const table = createTableFromData(anlageData, displayHeaders);
                    detailContainer.appendChild(table);
                }
            }
            resultsContainer.appendChild(detailContainer);
        }

        function renderSummaryView(data) {
            const summaryContainer = document.createElement('div');
            summaryContainer.className = 'mt-12';
            const title = document.createElement('h2');
            title.textContent = 'Zusammenfassung Materialbedarf';
            title.className = 'text-xl font-bold text-gray-800 mb-4';
            summaryContainer.appendChild(title);

            const summary = data.reduce((acc, row) => {
                const matNr = row['Material-Nr'];
                if (!matNr) return acc;

                const stueck = parseInt(row['Stück'], 10) || 0;
                if (!acc[matNr]) {
                    const descParts = [row['Filter-Klasse'], row['Filter-Typ.'], row['Maße [mm]']].filter(Boolean);
                    acc[matNr] = {
                        'Material-Nr': matNr,
                        'Beschreibung': descParts.join(', '),
                        'Gesamtstückzahl': 0
                    };
                }
                acc[matNr]['Gesamtstückzahl'] += stueck;
                return acc;
            }, {});

            const summaryData = Object.values(summary).sort((a, b) => naturalSort(String(a['Material-Nr']), String(b['Material-Nr'])));
            const summaryHeaders = ['Material-Nr', 'Beschreibung', 'Gesamtstückzahl'];
            const table = createTableFromData(summaryData, summaryHeaders);
            summaryContainer.appendChild(table);
            resultsContainer.appendChild(summaryContainer);
        }

        printButton.addEventListener('click', () => {
            window.print();
        });

    </script>
</body>
</html>
